

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Mapping vector data with base graphics in R</title>
    <meta name="description" content="">
    <meta name="author" content="Jon Katz">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap styles -->
    <link href="/assets/themes/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional theme -->
    <link href="/assets/themes/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Sticky Footer -->
    <link href="/assets/themes/bootstrap/css/bs-sticky-footer.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <link rel="stylesheet" href="/assets/font-awesome-4.6.2/css/font-awesome.min.css">
    <link href="/assets/themes/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/css/jonkatz2.css?body=1" rel="stylesheet" type="text/css" media="all">
    
    <!-- Include jQuery via CDN  -->
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
    
    <!-- Include a script highlighter via CDN  -->
    <!-- see http://balupton.github.io/jquery-syntaxhighlighter/demo/ -->
    <script type="text/javascript" src="http://balupton.github.com/jquery-syntaxhighlighter/scripts/jquery.syntaxhighlighter.min.js"></script>
    <script type="text/javascript">$.SyntaxHighlighter.init();</script>
    
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->

    <!-- atom & rss feed -->
    <link href="nil" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="nil" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <!-- JK: a navbar over all content -->
    <div>
      <nav class="navbar navbar-default" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#jb-navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Jon Katz</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="jb-navbar-collapse">
          <ul class="nav navbar-nav">
<!--    This is the liquid default      -->
<!--            -->
<!--            -->
<!--            


  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/about">About Me</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/blog">Blog</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/resume">Resume</a></li>
      	
      
    
  
    
      
    
  


-->
        <!--This is my version-->
          	<li><a href="/blog">Blog</a></li>
          	<li><a href="/resume">Resume</a></li>
            <li><a href="/about">About Me</a></li>
          </ul>
          <form class="navbar-form navbar-right" role="search">
            <div class="form-group">
              <input type="text" class="form-control" placeholder="Search">
            </div>
            <button type="submit" class="btn btn-default">Submit</button>
          </form>
        </div><!-- /.navbar-collapse -->
      </nav>
  
      <div class="container-fluid">
        

<div class="page-header">
  <h1>Mapping vector data with base graphics in R </h1>
</div>

<div class="row post-full">
  <div class="col-xs-12">
    <div class="date">
      <span>01 May 2016</span>
    </div>
    <div class="content">
      
<h3 id="spplot-and-ggplot-both-make-maps-in-r-but-both-are-hard-to-use-are-base-graphics-any-easier">spplot and ggplot both make maps in R, but both are hard to use. Are base graphics any easier?</h3>

<p>When it comes to mapping in R, you can take your pick of methods. If you are reading this post, you’ve probably already done a fair amount of web searching and seen a few other popular sites–you’ve probably searched the web a couple of times <strong>because mapping in R is tedious</strong>. I’ll single out a useful site that I refer to regularly, plus it links to many other excellent pages: <a href="">https://pakillo.github.io/R-GIS-tutorial/</a>. Go, follow the link and look around there, and then come back and see what the base graphics have to offer.</p>

<p>The two popular methods mentioned both have pros and cons:</p>

<table>
    <tr>
        <th style="width:6%;"></th>
        <th style="text-align:center;width:42%;"> sp::spplot </th>
        <th style="text-align:center;width:42%;"> ggplot2::ggplot </th>
    </tr>
    <tr>
        <td style="padding: 0em 1em;width:6%;"> <i class="fa fa-thumbs-up fa-2x" aria-hidden="true"></i> </td>
        <td style="padding: 0em 1em;width:42%;"> Fine control of overlays for a professionally finished look. </td>
        <td style="padding: 0em 1em;width:42%;"> Fine control of overlays for a professionally finished look. </td>
    </tr>
    <tr>
        <td style="padding: 0em 1em;width:6%;"> <i class="fa fa-thumbs-down fa-2x" aria-hidden="true"></i> </td>
        <td style="padding: 0em 1em;width:42%;"> Uses lattice, an implementation of Trellis graphics for R. </td>
        <td style="padding: 0em 1em;width:42%;"> ggplot is the grammar of graphics, which is also a whole different plotting language implemented in R. </td>
    </tr>
</table>
<p><br /></p>

<p>Well, it turns out they both have the same pro and the same con. In any case, neither plays well with R’s base graphics, which is a bummer for me because I’ve finally memorized the entire list of <code class="highlighter-rouge">par</code> options. While the trend-following part of me wants to learn ggplot because the plots are slick and colorful, the swim-against-the-current, roll-your-own-everything part of me prefers a good old-fashioned black-and-white line graph. I might be in the minority on this one, but I happen to really like the austerity of plots produced by the base graphics.</p>

<p>For mapping I am usually in a small hurry, so oftentimes I use the base graphics because I think they require less setup: read in a layer, send the plot command, and be done.</p>

<p>Let’s run through a quick example, and you can decide whether this sounds painful compared to ggplot. Before we start, I’d like to make a quick note about how we can find package help.</p>

<h3 id="getting-help-with-plot-methods">Getting help with plot methods</h3>
<p>Finding help for S4 methods takes a little getting used to. What I need to re-learn every month or so is that the <code class="highlighter-rouge">methods</code> package extends functionality of the <code class="highlighter-rouge">'?'</code> function, so as you might get help for an S3 plot method with <code class="highlighter-rouge">?plot</code> or <code class="highlighter-rouge">?plot.data.frame</code>, you get help for an S4 method such as plotting an object of class <code class="highlighter-rouge">SpatialPoints</code> with the command <code class="highlighter-rouge">method?plot('SpatialPoints')</code>. Its a little more cumbersome compared to S3 method dispatch, but for the most part I believe the S4 methodology is worth the hassle, so I put up with it.</p>

<h3 id="quick-choropleth-mapping-with-base-graphics">Quick choropleth mapping with base graphics</h3>
<p>The general outline of our task today is:</p>

<blockquote>
  <ol>
    <li>Get the homes for sale data.</li>
    <li>Aggregate the data by town.</li>
    <li>Plot the aggregated data.</li>
    <li>See what can be done to make ourselves more proud of the plot.</li>
  </ol>
</blockquote>

<h4 id="get-the-data">1. Get the data</h4>
<p>To keep this simple I’ll just read in some data rather than finding it right now. Our sample data today will be the subject of a future post: homes for sale in Vermont, scraped from Zillow’s website. I’ll read in a snapshot of homes for sale on May 1, 2016.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">zdata</span> <span class="o">&lt;-</span> <span class="n">read.csv</span><span class="p">(</span><span class="s1">'data/FS_2016May01.csv'</span><span class="p">)</span>

<span class="c1"># Get a random preview of the table
</span><span class="n">zdata</span><span class="p">[</span><span class="n">sample</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">zdata</span><span class="p">),</span> <span class="m">20</span><span class="p">),]</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>##                z_id                                          address
## 86  zpid_2098805784                      Hathaway-Trl-Dover-VT-05356
## 505 zpid_2098847499 83-S-Jefferson-Rd-39-R-South-Burlington-VT-05403
## 306   zpid_75444614     3534-Sawnee-Bean-Rd-Thetford-Center-VT-05075
## 350 zpid_2144685253          3-Haycorn-Hollow-Rd-South-Hero-VT-05486
## 504   zpid_92005276                333-Lower-Main-W-Johnson-VT-05656
## 166 zpid_2107354132                  12-Ketch-Rd-Grand-Isle-VT-05458
## 21    zpid_12651227                   80-Ward-St-Burlington-VT-05401
## 206   zpid_75459794               17-W-Crystal-Hvn-Bomoseen-VT-05732
## 423 zpid_2102587266                      752-Cook-Rd-Barton-VT-05822
## 204   zpid_75432590                  1-Twin-Ct-Saint-Albans-VT-05478
## 395 zpid_2098863215                     850-Park-St-Brandon-VT-05733
## 349 zpid_2098898520     236-Qtr-I-I-Jackson-Gore-Inn-Ludlow-VT-05149
## 8     zpid_81613208           21-Glen-Ridge-Ln-Saint-Albans-VT-05478
## 96    zpid_75452756                  5695-Route-14-Irasburg-VT-05845
## 302 zpid_2098865675      N15-Stonehedge-Dr-South-Burlington-VT-05403
## 383 zpid_2133613637           1033-Portland-St-St-Johnsbury-VT-05819
## 131 zpid_2098804675                  0-N-Route-30-N-Sudbury-VT-05733
## 486 zpid_2116639515                    127-South-St-Rutland-VT-05701
## 304   zpid_75467230                  15-Ewing-St-Montpelier-VT-05602
## 301 zpid_2098842580           1903-Vt-Rte-100-South-Duxbury-VT-05660
##          lat      long  price beds baths sqft        acres yr_built
## 86  42.97606 -72.86359 300000   NA    NA   NA        95.20       NA
## 505 44.43980 -73.19180 424900  3.0     3 1775           NA     2016
## 306 43.87669 -72.28931 555000  3.0     2 2317        95.00     1978
## 350 44.64687 -73.28166 175000  2.0     1  732         1.00     1920
## 504 44.63641 -72.68568 200000  3.0     2 1900         0.40     1890
## 166 44.70205 -73.29071 113000   NA     1  512           NA       NA
## 21  44.48743 -73.22118 199900  2.0     1  928           NA       NA
## 206 43.66443 -73.19317 450000  3.0     2 1892 738963950.69     1940
## 423 44.76370 -72.11372  65000   NA     1  480        10.40     2004
## 204 44.79575 -73.08109 221500  3.0     2 1572         0.51     1983
## 395 43.80371 -73.07260 230000  6.0     3 3202         4.00     1850
## 349 43.40596 -72.69549  31000  0.5     1  390           NA     2003
## 8   44.90524 -73.06560 197000  3.0     1 1458           NA       NA
## 96  44.79241 -72.29267 159900  3.0     1   NA        10.00     1978
## 302 44.43470 -73.19590 244000  4.0     3 2076           NA     1988
## 383 44.42179 -71.99540  89900  3.0     2 1508         0.50     1900
## 131 43.79329 -73.20483  70000   NA    NA   NA         5.53       NA
## 486 43.60036 -72.98443  75000  4.0     2 3006 971089554.22     1919
## 304 44.26341 -72.56707 230000  3.0    NA 1476           NA     1900
## 301 44.26225 -72.78795 340000  3.0     3 2296        35.00     1988
</code></pre>
</div>

<p>Data scraped from a web page is bound to be missing a fair number of values, and that seems to be true here. As far as I can tell the <code class="highlighter-rouge">lat</code> and <code class="highlighter-rouge">long</code> fields are intact though.</p>

<p>I’m going to limit this post to vector data so I can keep the packages to a minimum.<br />
Now I can convert our zillow data to a Spatial object and read in a shapefile with Vermont town boundaries:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">rgdal</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span> <span class="c1"># for its summary print method
</span>
<span class="c1"># Convert zillow data to a SpatialPointsDataFrame using the International Association 
# of Oil &amp; Gas Producers EPSG code for WGS84 projection:
</span><span class="n">z.spat</span> <span class="o">&lt;-</span> <span class="n">SpatialPointsDataFrame</span><span class="p">(</span><span class="n">zdata</span><span class="p">[,</span><span class="n">c</span><span class="p">(</span><span class="s1">'long'</span><span class="p">,</span> <span class="s1">'lat'</span><span class="p">)],</span> <span class="n">data</span><span class="o">=</span><span class="n">zdata</span><span class="p">,</span> <span class="n">proj4string</span><span class="o">=</span><span class="n">CRS</span><span class="p">(</span><span class="s2">"+init=epsg:4326"</span><span class="p">))</span>

<span class="c1"># Read in town boundaries
</span><span class="n">vt.twn</span> <span class="o">&lt;-</span> <span class="n">readOGR</span><span class="p">(</span><span class="n">dsn</span><span class="o">=</span><span class="s1">'data/Boundary_TWNBNDS'</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s1">'Boundary_TWNBNDS_poly'</span><span class="p">)</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## OGR data source with driver: ESRI Shapefile 
## Source: "data/Boundary_TWNBNDS", layer: "Boundary_TWNBNDS_poly"
## with 255 features
## It has 5 fields
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">vt.twn</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## class       : SpatialPolygonsDataFrame 
## features    : 255 
## extent      : 424788.8, 581562, 25211.84, 279799  (xmin, xmax, ymin, ymax)
## coord. ref. : +proj=tmerc +lat_0=42.5 +lon_0=-72.5 +k=0.9999642857142857 +x_0=500000 +y_0=0 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0 
## variables   : 5
## names       : FIPS6,  TOWNNAME, CNTY, SHAPE_area, SHAPE_len 
## min values  :  1005,   ADDISON,    1,  100122404, 10203.963 
## max values  :  9095, WORCESTER,    9,   99942616,  9386.921
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1"># transform town boundary projection to match the points
</span><span class="n">vt.twn</span> <span class="o">&lt;-</span> <span class="n">spTransform</span><span class="p">(</span><span class="n">vt.twn</span><span class="p">,</span> <span class="n">CRSobj</span><span class="o">=</span><span class="n">proj4string</span><span class="p">(</span><span class="n">z.spat</span><span class="p">))</span>
</code></pre>
</div>
<p>To see how quickly the base graphics get us up and running with a visual, lets plot the points.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="n">vt.twn</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">z.spat</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">pch</span><span class="o">=</span><span class="m">19</span><span class="p">)</span>
</code></pre>
</div>

<!--![plot of chunk unnamed-chunk-3](/assets/blog/mappingZillow/figure/unnamed-chunk-3-1.png) -->

<p>For a quick side-by-side comparison, here’s our plot on the left and Zillow’s map on it’s home site grabbed the same day:</p>
<div>
    <img style="width:47%;float:left;" src="/assets/blog/mappingZillow/figure/unnamed-chunk-3-1.png" alt="Our plot 20160501" />
    <img style="width:52%;float:right;" src="/assets/blog/mappingZillow/img/vtZillow20160501.png" alt="Zillow Screengrab 20160501" />
</div>
<div style="clear:both;"></div>

<h4 id="aggregate-the-data-by-town">2. Aggregate the data by town.</h4>
<p>Now that everything appears to be in order, I’d like to shade the map according to one or more of the attributes in the data. I’ll begin with home median home price by town. The package <code class="highlighter-rouge">sp</code> has a great spatial aggregation method, so there’s no need to explicitly do any overlay.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">price</span> <span class="o">&lt;-</span> <span class="n">aggregate</span><span class="p">(</span><span class="n">z.spat</span><span class="p">[</span><span class="s1">'price'</span><span class="p">],</span> <span class="n">by</span><span class="o">=</span><span class="n">vt.twn</span><span class="p">[</span><span class="s1">'TOWNNAME'</span><span class="p">],</span> <span class="n">FUN</span><span class="o">=</span><span class="n">median</span><span class="p">,</span> <span class="n">na.rm</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span> 
<span class="n">price</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## class       : SpatialPolygonsDataFrame 
## features    : 255 
## extent      : -73.4379, -71.46528, 42.72696, 45.01666  (xmin, xmax, ymin, ymax)
## coord. ref. : +init=epsg:4326 +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 
## variables   : 1
## names       :   price 
## min values  :   50000 
## max values  : 1395000
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1"># see what values price has
</span><span class="n">hist</span><span class="p">(</span><span class="n">price</span><span class="o">$</span><span class="n">price</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s1">'Median home price by Vermont town'</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s1">'Price in US Dollars'</span><span class="p">)</span>
</code></pre>
</div>

<p><img id="finalMapImg" style="width:100%;" src="/assets/blog/mappingZillow/figure/unnamed-chunk-4-1.png" alt="The final map" /> 
<!--![plot of chunk unnamed-chunk-4](/assets/blog/mappingZillow/figure/unnamed-chunk-4-1.png) --></p>

<p>Judging from the histogram, most homes for sale in Vermont are asking less than $400,000, but several are asking more than $1.2M. This is going to make shading this map a little harder than I initially expected, and it is going to bump up the complexity of the code we write.<br />
I’ll start with a simple linear shading scheme, using the built-in <code class="highlighter-rouge">heat.colors</code> gradient for the <code class="highlighter-rouge">col</code> argument.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="n">price</span><span class="p">[</span><span class="s1">'price'</span><span class="p">],</span> <span class="n">col</span><span class="o">=</span><span class="n">heat.colors</span><span class="p">(</span><span class="m">255</span><span class="p">),</span> 
    <span class="n">main</span><span class="o">=</span><span class="s1">'Median home price in Vermont, by town'</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span>
<span class="n">box</span><span class="p">()</span>
</code></pre>
</div>
<p><img id="finalMapImg" style="width:100%;" src="/assets/blog/mappingZillow/figure/unnamed-chunk-5-1.png" alt="The final map" /> 
<!--![plot of chunk unnamed-chunk-5](/assets/blog/mappingZillow/figure/unnamed-chunk-5-1.png) --></p>

<p>OK, it is clear from this plot that the method just colors towns by plot order rather than by the underlying value in the attribute table. Another complication; maybe this is not as simple as I initially expected.</p>

<p>After testing various options for a solid hour, here’s what I came up with. I can’t change the plot order, but I <em>can</em> change the coloration. I need to rearrange the colors in <code class="highlighter-rouge">heat.colors()</code> and take them from a simple ramp to a vector arranged according to the median home price per town. The steps I’d like to perform are:</p>

<blockquote>
  <ol>
    <li>Use the <code class="highlighter-rouge">hist</code> function to compute price bins.</li>
    <li>Assign the prices to bins.</li>
    <li>Use the assigned bins to rarrange the color vector.</li>
    <li>Plot the map.</li>
    <li>Return an invisible vector of bins to use in the legend.</li>
  </ol>
</blockquote>

<p>I’m going to do this by defining a quick custom function. The “quick” part is that I’m not including any argument checking characteristic of a high level function in a package.<br />
The following function will perform the above steps.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">choropleth</span> <span class="o">&lt;-</span> <span class="k">function</span><span class="p">(</span>
    <span class="n">sp</span><span class="p">,</span>         <span class="c1"># R object--any feature derived from package sp.
</span>    <span class="n">attrib</span><span class="p">,</span>     <span class="c1"># Attribute name in the table; length 1 character vector.
</span>    <span class="n">color.ramp</span><span class="o">=</span><span class="n">heat.colors</span><span class="p">,</span>  <span class="c1"># The color ramp to use. Can also use colorRampPalette().
</span>    <span class="n">hist.args</span><span class="o">=</span><span class="n">NULL</span><span class="p">,</span>  <span class="c1"># Named list of additional arguments to hist(), excluding `plot`.
</span>    <span class="k">...</span>         <span class="c1"># Additional arguments to plot().
</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">spa</span> <span class="o">&lt;-</span> <span class="n">na.omit</span><span class="p">(</span><span class="n">sp</span><span class="p">[[</span><span class="n">attrib</span><span class="p">]])</span>
    <span class="c1"># Step 1 : compute price bins
</span>    <span class="n">ha</span> <span class="o">&lt;-</span> <span class="n">list</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">spa</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">FALSE</span><span class="p">)</span>
    <span class="n">ha</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">hist.args</span><span class="p">)</span>
    <span class="n">bins</span> <span class="o">&lt;-</span> <span class="n">do.call</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">ha</span><span class="p">)</span><span class="o">$</span><span class="n">breaks</span>
    <span class="c1"># Step 2: assign data to bins
</span>    <span class="n">bin</span> <span class="o">&lt;-</span> <span class="n">rep</span><span class="p">(</span><span class="n">NA</span><span class="p">,</span> <span class="n">length</span><span class="p">(</span><span class="n">spa</span><span class="p">))</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="n">length</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span><span class="o">:</span><span class="m">1</span><span class="p">)</span> <span class="n">bin</span><span class="p">[</span><span class="n">spa</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="o">&amp;</span> <span class="n">spa</span> <span class="o">&lt;=</span> <span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">i</span><span class="m">-1</span>
    <span class="c1"># Step 3: rearrange color vector
</span>    <span class="n">sp</span><span class="o">$</span><span class="n">bin</span> <span class="o">&lt;-</span> <span class="n">NA</span>
    <span class="n">sp</span><span class="p">[[</span><span class="s1">'bin'</span><span class="p">]][</span><span class="o">!</span><span class="n">is.na</span><span class="p">(</span><span class="n">sp</span><span class="p">[[</span><span class="n">attrib</span><span class="p">]])]</span> <span class="o">&lt;-</span> <span class="n">bin</span>
    <span class="n">customcolor</span> <span class="o">&lt;-</span> <span class="n">rev</span><span class="p">(</span><span class="n">color.ramp</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span><span class="m">-1</span><span class="p">))</span>
    <span class="n">customcolor</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="s2">"#FFFFFF"</span>
    <span class="c1"># Step 4: plot
</span>    <span class="n">plot</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">customcolor</span><span class="p">[</span><span class="n">sp</span><span class="o">$</span><span class="n">bin</span><span class="p">],</span> <span class="k">...</span><span class="p">)</span>
    <span class="c1"># Step 5: return a vector to use for the legend
</span>    <span class="n">low.bin</span> <span class="o">&lt;-</span> <span class="n">bins</span> <span class="o">+</span> <span class="m">1</span>
    <span class="n">low.bin</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="m">0</span>
    <span class="n">oldopts</span> <span class="o">&lt;-</span> <span class="n">options</span><span class="p">(</span><span class="n">scipen</span><span class="o">=</span><span class="m">100000</span><span class="p">)</span>
    <span class="n">on.exit</span><span class="p">(</span><span class="n">options</span><span class="p">(</span><span class="n">oldopts</span><span class="p">))</span>
    <span class="n">invisible</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="n">low.bin</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">low.bin</span><span class="p">)</span><span class="m">-1</span><span class="p">)],</span> <span class="s1">'-'</span><span class="p">,</span> <span class="n">bins</span><span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="n">bins</span><span class="p">)]))</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now the first test. I’m going to put a legend on right away, just to see how it looks.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">x</span> <span class="o">&lt;-</span> <span class="n">choropleth</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="s1">'price'</span><span class="p">,</span> 
    <span class="n">main</span><span class="o">=</span><span class="s1">'Median home price in Vermont, by town'</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span>
    
<span class="n">legend</span><span class="p">(</span><span class="s1">'bottomright'</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">rev</span><span class="p">(</span><span class="n">heat.colors</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">x</span><span class="p">))),</span> 
    <span class="n">bty</span><span class="o">=</span><span class="s1">'n'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">'$US'</span><span class="p">)</span>
    
<span class="n">box</span><span class="p">()</span>
</code></pre>
</div>
<p><img id="finalMapImg" style="width:100%;" src="/assets/blog/mappingZillow/figure/unnamed-chunk-7-1.png" alt="The final map" /> 
<!--![plot of chunk unnamed-chunk-7](/assets/blog/mappingZillow/figure/unnamed-chunk-7-1.png) --></p>

<p>This looks more-or-less OK, but I’ve plotted two oranges and three reds that I can’t distinguish, and my legend shows two yellows but the lighter one is probably white in the map. I need to fix the white, and follow it up with more distinct colors. I will solve this with a one-two punch to improve my odds of success. First I’ll set up my color ramp to transition between three colors. Second, since I’m using <code class="highlighter-rouge">hist()</code> to compute breaks, I can pass breaks into the above function manually (which almost defeats the purpose of using <code class="highlighter-rouge">hist</code>). I want finely divided breaks between 1 and $450,000 and then one category for all prices higher than $450,000.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">fill.col</span> <span class="o">&lt;-</span> <span class="n">colorRampPalette</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="s1">'red'</span><span class="p">,</span> <span class="s1">'orange'</span><span class="p">,</span> <span class="s1">'lightgray'</span><span class="p">))</span>

<span class="n">x</span> <span class="o">&lt;-</span> <span class="n">choropleth</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="s1">'price'</span><span class="p">,</span> <span class="n">color.ramp</span><span class="o">=</span><span class="n">fill.col</span><span class="p">,</span> 
   <span class="n">hist.args</span><span class="o">=</span><span class="n">list</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">seq</span><span class="p">(</span><span class="m">250000</span><span class="p">,</span> <span class="m">450000</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="m">100000</span><span class="p">),</span> <span class="m">1500000</span><span class="p">)),</span> 
   <span class="n">main</span><span class="o">=</span><span class="s1">'Median home price in Vermont, by town'</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span>

<span class="n">fill</span> <span class="o">&lt;-</span> <span class="n">rev</span><span class="p">(</span><span class="n">fill.col</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

<span class="n">fill</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="s1">'white'</span>

<span class="n">legend</span><span class="p">(</span><span class="s1">'bottomright'</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">fill</span><span class="p">,</span> <span class="n">bty</span><span class="o">=</span><span class="s1">'n'</span><span class="p">,</span> 
   <span class="n">title</span><span class="o">=</span><span class="s1">'Asking Price ($US)'</span><span class="p">,</span> <span class="n">box.cex</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">0.8</span><span class="p">))</span>

<span class="n">box</span><span class="p">()</span>
</code></pre>
</div>
<p><img id="finalMapImg" style="width:100%;" src="/assets/blog/mappingZillow/figure/unnamed-chunk-8-1.png" alt="The final map" /> 
<!-- ![plot of chunk unnamed-chunk-8](/assets/blog/mappingZillow/figure/unnamed-chunk-8-1.png) --></p>

<p>Now some finishing touches that I’ll discuss more in a future post: a scale bar, a north arrow, larger fill-boxes in the legend, and labels for both town name and count of homes for sale. Click on the map to see it larger.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">source</span><span class="p">(</span><span class="s1">'mapFunctions.R'</span><span class="p">)</span>
<span class="n">source</span><span class="p">(</span><span class="s2">"http://www.math.mcmaster.ca/bolker/R/misc/legendx.R"</span><span class="p">)</span>

<span class="n">fill.col</span> <span class="o">&lt;-</span> <span class="n">colorRampPalette</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="s1">'red'</span><span class="p">,</span> <span class="s1">'orange'</span><span class="p">,</span> <span class="s1">'lightgray'</span><span class="p">))</span>

<span class="n">x</span> <span class="o">&lt;-</span> <span class="n">choropleth</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="s1">'price'</span><span class="p">,</span> <span class="n">color.ramp</span><span class="o">=</span><span class="n">fill.col</span><span class="p">,</span> 
    <span class="n">hist.args</span><span class="o">=</span><span class="n">list</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">seq</span><span class="p">(</span><span class="m">250000</span><span class="p">,</span> <span class="m">450000</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="m">100000</span><span class="p">),</span> <span class="m">1500000</span><span class="p">)),</span> 
    <span class="n">main</span><span class="o">=</span><span class="s1">'Median home price in Vermont, by town'</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span>

<span class="n">fill</span> <span class="o">&lt;-</span> <span class="n">rev</span><span class="p">(</span><span class="n">fill.col</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

<span class="n">fill</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="s1">'white'</span>

<span class="n">legend</span><span class="p">(</span><span class="s1">'bottomright'</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">fill</span><span class="p">,</span> <span class="n">bty</span><span class="o">=</span><span class="s1">'n'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">'Asking Price ($US)'</span><span class="p">,</span> 
    <span class="n">box.cex</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">0.8</span><span class="p">),</span> <span class="n">inset</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">.25</span><span class="p">))</span>

<span class="n">scalebarTanimura</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'bottomright'</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="m">0.3960193</span><span class="p">,</span> <span class="n">inset</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">0.52</span><span class="p">,</span> <span class="m">-0.75</span><span class="p">),</span> 
    <span class="n">mapunit</span><span class="o">=</span><span class="s1">'degrees'</span><span class="p">,</span> <span class="n">unit.lab</span><span class="o">=</span><span class="s2">"miles"</span><span class="p">)</span>
<span class="n">northarrowTanimura</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'bottomright'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="m">0.4</span><span class="p">,</span> <span class="n">inset</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">),</span> <span class="n">mapunit</span><span class="o">=</span><span class="s1">'degrees'</span><span class="p">)</span>

<span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">coordinates</span><span class="p">(</span><span class="n">vt.twn</span><span class="p">)[,</span><span class="m">1</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">coordinates</span><span class="p">(</span><span class="n">vt.twn</span><span class="p">)[,</span><span class="m">2</span><span class="p">],</span> 
    <span class="n">labels</span><span class="o">=</span><span class="n">vt.twn</span><span class="o">$</span><span class="n">TOWNNAME</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="m">3</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="m">0.3</span><span class="o">/</span><span class="m">2</span><span class="p">,</span> <span class="n">cex</span><span class="o">=</span><span class="m">0.3</span><span class="p">)</span>

<span class="n">count</span> <span class="o">&lt;-</span> <span class="n">aggregate</span><span class="p">(</span><span class="n">z.spat</span><span class="p">[</span><span class="s1">'price'</span><span class="p">],</span> <span class="n">by</span><span class="o">=</span><span class="n">vt.twn</span><span class="p">[</span><span class="s1">'TOWNNAME'</span><span class="p">],</span> <span class="n">FUN</span><span class="o">=</span><span class="n">length</span><span class="p">)</span> 

<span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">coordinates</span><span class="p">(</span><span class="n">vt.twn</span><span class="p">)[,</span><span class="m">1</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">coordinates</span><span class="p">(</span><span class="n">vt.twn</span><span class="p">)[,</span><span class="m">2</span><span class="p">],</span> 
    <span class="n">labels</span><span class="o">=</span><span class="n">count</span><span class="o">$</span><span class="n">price</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="m">0.6</span><span class="o">/</span><span class="m">2</span><span class="p">,</span> <span class="n">cex</span><span class="o">=</span><span class="m">0.6</span><span class="p">)</span>

<span class="n">box</span><span class="p">()</span>
</code></pre>
</div>

<!-- Trigger the modal-->
<p><a href="#" data-toggle="modal" data-target="#myModal">
    <img id="finalMapImg" style="width:100%;" src="/assets/blog/mappingZillow/figure/unnamed-chunk-9-1.png" alt="The final map" /> 
</a>
<!-- Modal --></p>
<div id="myModal" class="modal fade" role="dialog" aria-hidden="true">
  <div class="modal-dialog" style="width:1000px;">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
         <h4 class="modal-title"> </h4>
      </div>
      <div class="modal-body">
        <div style="overflow:hidden;"> 
          <img id="finalMapImgLg" style="width:950px;" src="/assets/blog/mappingZillow/figure/unnamed-chunk-10-1.png" alt="The final map" />
        </div>
        <!-- <p>Some text in the modal.</p>-->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>


    </div>

    

  
    <ul class="tag_box inline">
      <li><i class="glyphicon glyphicon-tags"></i></li>
      
      


  
     
    	<li><a href="nil#R-ref">R <span>4</span></a></li>
     
    	<li><a href="nil#Spatial analysis-ref">Spatial analysis <span>1</span></a></li>
     
    	<li><a href="nil#Mapping-ref">Mapping <span>1</span></a></li>
     
    	<li><a href="nil#GIS-ref">GIS <span>1</span></a></li>
     
    	<li><a href="nil#Code-ref">Code <span>1</span></a></li>
    
  



    </ul>
    
  
    <hr>
    <ul class="pagination">
    
      <li class="prev disabled"><a>&larr; Previous</a></li>
    
      <li><a href="nil">Archive</a></li>
    
      <li class="next"><a href="/2016/05/13/Web-scraping-with-R" title="Web scraping with R">Next &raquo;</a></li>
    
    </ul>
    <hr>
    




  </div>
</div>


      </div>

    </div>

<!--    <div id="footer">-->
<!--      <div class="container">-->
<!--        <p>&copy; 2017 Jon Katz-->
<!--          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>-->
<!--          and <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>-->
<!--        </p>-->
<!--      </div>-->
<!--    </div>-->
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-104441725-1', 'auto');
  ga('send', 'pageview');

</script>

<!--    


-->


    <!-- Latest compiled and minified JavaScript, requires jQuery 1.x (2.x not supported in IE8) -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="/assets/themes/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>

